<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Untitled</title>
    

  </head>
    
  <body>
  <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Overlay System */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .overlay-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 2px solid #3498db;
        }

        .overlay h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .overlay p {
            color: #7f8c8d;
            margin-bottom: 25px;
            font-size: 16px;
        }

        /* Progress Bar Styles */
        .progress-container {
            width: 100%;
            background: #ecf0f1;
            border-radius: 10px;
            margin: 25px 0;
            overflow: hidden;
            height: 12px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 10px;
            width: 0%;
            transition: width 0.4s ease;
            position: relative;
        }

        .progress-text {
            margin-top: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        /* Success Animation */
        .success-animation {
            font-size: 60px;
            color: #2ecc71;
            margin-bottom: 20px;
            animation: bounce 0.6s ease-in-out 2;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }

        /* Upload Progress Bar */
        .upload-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: #e0e0e0;
            z-index: 9999;
            display: none;
        }

        .upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .upload-progress-text {
            position: absolute;
            top: 8px;
            right: 20px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #3498db;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 32px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .user-info i {
            color: #3498db;
            font-size: 20px;
        }

        .user-details {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .user-email {
            font-size: 12px;
            color: #6c757d;
        }

        .back-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .back-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 35px;
            margin-bottom: 30px;
            transition: transform 0.3s, box-shadow 0.3s;
            border-top: 5px solid #2ecc71;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 26px;
            border-bottom: 2px solid #f1f2f6;
            padding-bottom: 15px;
        }

        h2 i {
            color: #3498db;
            background: #e1f0fa;
            padding: 10px;
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 28px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #eef2f7;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #fafbfc;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.15);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }

        .locations-edit {
            margin-bottom: 15px;
        }

        .location-edit-item {
            display: flex;
            margin-bottom: 12px;
            gap: 12px;
        }

        .location-input {
            flex-grow: 1;
        }

        .remove-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 10px;
            width: 45px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .remove-btn:hover {
            transform: scale(1.05);
        }

        .add-location-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .add-location-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 18px;
            margin-top: 35px;
            padding-top: 25px;
            border-top: 2px solid #f1f2f6;
        }

        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(149, 165, 166, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .alert {
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: none;
            animation: fadeIn 0.5s;
            border-left: 5px solid;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .form-row {
            display: flex;
            gap: 25px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .photo-upload {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            margin-bottom: 25px;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafbfc;
        }

        .photo-upload:hover {
            border-color: #3498db;
            background: #f0f7ff;
            transform: translateY(-5px);
        }

        .photo-upload i {
            font-size: 60px;
            color: #7f8c8d;
            margin-bottom: 20px;
            transition: color 0.3s;
        }

        .photo-upload:hover i {
            color: #3498db;
        }

        .photo-preview {
            display: none;
            max-width: 100%;
            margin-top: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 3px solid #eef2f7;
            max-height: 300px;
            object-fit: cover;
        }

        .preview-container {
            position: relative;
            display: inline-block;
        }

        .remove-photo {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .remove-photo:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .current-photo-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            display: none;
        }

        .current-photo-info p {
            margin: 5px 0;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 25px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 28px;
            }
        }

        .form-section {
            background: #f8fafc;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #3498db;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
        }

        .form-section h3 i {
            color: #3498db;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            display: none;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            background: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            margin: 5px;
            font-size: 14px;
        }

        .tag i {
            margin-left: 8px;
            cursor: pointer;
            opacity: 0.8;
        }

        .tag i:hover {
            opacity: 1;
        }

        .tag-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tag-input {
            flex: 1;
        }

        .add-tag-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
            height: 20px;
            margin-bottom: 10px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .user-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .user-info .fa-user-circle {
            font-size: 40px;
            color: #6c757d;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .user-email {
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .user-photo {
                width: 35px;
                height: 35px;
            }
            
            .user-info .fa-user-circle {
                font-size: 35px;
            }
            
            .user-name {
                font-size: 13px;
            }
            
            .user-email {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <!-- Overlay System -->
    <div class="overlay" id="overlay">
        <div class="overlay-content">
            <h3 id="overlay-title">Processing</h3>
            <p id="overlay-message">Please wait while we process your request...</p>
            
            <div class="progress-container">
                <div class="progress-bar" id="overlay-progress-bar"></div>
            </div>
            <div class="progress-text" id="overlay-progress-text">0%</div>
            
            <div id="success-content" style="display: none;">
                <div class="success-animation">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 id="success-title">Operation Completed</h3>
                <p id="success-message">Your changes have been saved</p>
                <button class="btn btn-success" onclick="hideOverlay()">
                    <i class="fas fa-check"></i> Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Upload Progress Bar -->
    <div class="upload-progress" id="upload-progress">
        <div class="upload-progress-bar" id="upload-progress-bar">
            <div class="upload-progress-text" id="upload-progress-text">0%</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-route" id="page-icon"></i> <span id="page-title">Trip Manager</span></h1>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="user-info" id="user-info">
                    <i class="fas fa-user-circle"></i>
                    <div class="user-details">
                        <div class="user-name" id="user-name">
                            <div class="loading-skeleton" style="width: 120px;"></div>
                        </div>
                        <div class="user-email" id="user-email">
                            <div class="loading-skeleton" style="width: 150px;"></div>
                        </div>
                    </div>
                </div>
                <a href="#" class="back-btn" id="back-btn">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>

        <div class="alert alert-success" id="success-alert">
            <i class="fas fa-check-circle"></i> <span id="success-alert-message">Operation completed successfully</span>
        </div>

        <div class="alert alert-danger" id="error-alert">
            <i class="fas fa-exclamation-circle"></i> <span id="error-message"></span>
        </div>

        <div class="card">
            <h2><i class="fas fa-plus-circle" id="form-icon"></i> <span id="form-title">Manage Trip</span></h2>
            <form id="trip-form">
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Basic Information</h3>
                    <div class="form-group">
                        <label for="trip-name">Trip Name</label>
                        <input type="text" id="trip-name" class="form-control" placeholder="Enter an exciting trip name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="trip-description">Trip Description</label>
                        <textarea id="trip-description" class="form-control" rows="3" placeholder="Describe your amazing adventure"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-cog"></i> Trip Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="trip-duration">Duration (days)</label>
                            <input type="number" id="trip-duration" class="form-control" min="1" value="3">
                        </div>
                        
                        <div class="form-group">
                            <label for="trip-difficulty">Difficulty Level</label>
                            <select id="trip-difficulty" class="form-control">
                                <option value="Easy">Easy</option>
                                <option value="Moderate" selected>Moderate</option>
                                <option value="Challenging">Challenging</option>
                                <option value="Difficult">Difficult</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="trip-group-size">Group Size</label>
                            <input type="text" id="trip-group-size" class="form-control" value="Up to 12 People">
                        </div>
                        
                        <div class="form-group">
                            <label for="trip-price">Price ($)</label>
                            <div class="price-input">
                                <input type="number" id="trip-price" class="form-control" min="0" step="0.01" value="450">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-map-marker-alt"></i> Locations & Tags</h3>
                    <div class="form-group">
                        <label>Trip Locations</label>
                        <div class="locations-edit" id="trip-locations-container">
                            <div class="location-edit-item">
                                <input type="text" class="form-control location-input" placeholder="Enter a location">
                                <button type="button" class="remove-btn" onclick="removeLocationField(this)" disabled>
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="add-location-btn" id="add-location-btn">
                            <i class="fas fa-plus"></i> Add Location
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>Trip Tags</label>
                        <div class="tag-input-container">
                            <input type="text" class="form-control tag-input" id="tag-input" placeholder="Add a tag (e.g., hiking, adventure)">
                            <button type="button" class="add-tag-btn" id="add-tag-btn">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <div class="tag-container" id="tag-container">
                            <!-- Tags will be added here dynamically -->
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-camera"></i> Header Photo</h3>
                    <div class="current-photo-info" id="current-photo-info">
                        <p><strong>Current Photo:</strong> <span id="current-photo-name">No photo selected</span></p>
                    </div>
                    <div class="form-group">
                        <label id="photo-upload-label">Upload Header Photo</label>
                        <div class="photo-upload" id="photo-upload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p id="photo-upload-text">Click to upload a header photo for your trip</p>
                            <small>Recommended size: 1200x600 pixels | Max: 5MB</small>
                        </div>
                        <div class="preview-container">
                            <img id="photo-preview" class="photo-preview" alt="Photo preview">
                            <button type="button" class="remove-photo" id="remove-photo">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <input type="file" id="photo-input" accept="image/*" style="display: none;">
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" id="delete-trip-btn" style="display: none;">
                        <i class="fas fa-trash"></i> Delete Trip
                    </button>
                    <button type="button" class="btn btn-secondary" id="reset-btn">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save" id="submit-icon"></i> <span id="submit-text">Create Trip</span>
                    </button>
                </div>
            </form>
        </div>

        <div class="debug-info" id="debug-info">
            <!-- Debug information will be displayed here -->
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, update, remove, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBDrzrgLslaJvnXbo1e90irCEtdcm9ZsCU",
        authDomain: "logins-13661.firebaseapp.com",
        databaseURL: "https://logins-13661-default-rtdb.firebaseio.com",
        projectId: "logins-13661",
        storageBucket: "logins-13661.appspot.com",
        messagingSenderId: "451535349483",
        appId: "1:451535349483:web:d3c9867fd2bffbbdca40ae",
        measurementId: "G-DWP16WX2H7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const storage = getStorage(app);

    // DOM Elements
    const tripForm = document.getElementById('trip-form');
    const tripNameInput = document.getElementById('trip-name');
    const tripDescriptionInput = document.getElementById('trip-description');
    const tripDurationInput = document.getElementById('trip-duration');
    const tripDifficultyInput = document.getElementById('trip-difficulty');
    const tripGroupSizeInput = document.getElementById('trip-group-size');
    const tripPriceInput = document.getElementById('trip-price');
    const addLocationBtn = document.getElementById('add-location-btn');
    const locationsContainer = document.getElementById('trip-locations-container');
    const addTagBtn = document.getElementById('add-tag-btn');
    const tagInput = document.getElementById('tag-input');
    const tagContainer = document.getElementById('tag-container');
    const photoUpload = document.getElementById('photo-upload');
    const photoInput = document.getElementById('photo-input');
    const photoPreview = document.getElementById('photo-preview');
    const removePhotoBtn = document.getElementById('remove-photo');
    const resetBtn = document.getElementById('reset-btn');
    const backBtn = document.getElementById('back-btn');
    const successAlert = document.getElementById('success-alert');
    const errorAlert = document.getElementById('error-alert');
    const errorMessage = document.getElementById('error-message');
    const debugInfo = document.getElementById('debug-info');
    const deleteTripBtn = document.getElementById('delete-trip-btn');
    const currentPhotoInfo = document.getElementById('current-photo-info');
    const currentPhotoName = document.getElementById('current-photo-name');
    const userInfo = document.getElementById('user-info');
    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    const pageTitle = document.getElementById('page-title');
    const pageIcon = document.getElementById('page-icon');
    const formTitle = document.getElementById('form-title');
    const formIcon = document.getElementById('form-icon');
    const submitText = document.getElementById('submit-text');
    const submitIcon = document.getElementById('submit-icon');
    const photoUploadLabel = document.getElementById('photo-upload-label');
    const photoUploadText = document.getElementById('photo-upload-text');
    const successTitle = document.getElementById('success-title');
    const successMessage = document.getElementById('success-message');
    const successAlertMessage = document.getElementById('success-alert-message');
    
    // Overlay elements
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlay-title');
    const overlayMessage = document.getElementById('overlay-message');
    const overlayProgressBar = document.getElementById('overlay-progress-bar');
    const overlayProgressText = document.getElementById('overlay-progress-text');
    const successContent = document.getElementById('success-content');
    
    // Upload progress elements
    const uploadProgress = document.getElementById('upload-progress');
    const uploadProgressBar = document.getElementById('upload-progress-bar');
    const uploadProgressText = document.getElementById('upload-progress-text');

    // State variables
    let tags = [];
    let headerPhotoFile = null;
    let currentTripData = null;
    let currentHeaderPhoto = null;
    let pageId = null;
    let tripId = null;
    let currentUser = null;
    let currentUserId = null;
    let isEditMode = false;

    // Get URL parameters
    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            pageID: params.get('pageID'),
            tripID: params.get('tripID')
        };
    }

    // Event Listeners
    addLocationBtn.addEventListener('click', addLocationField);
    addTagBtn.addEventListener('click', addTag);
    tagInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addTag();
        }
    });
    photoUpload.addEventListener('click', () => photoInput.click());
    photoInput.addEventListener('change', handlePhotoUpload);
    removePhotoBtn.addEventListener('click', removeCurrentPhoto);
    resetBtn.addEventListener('click', resetForm);
    backBtn.addEventListener('click', (e) => {
        e.preventDefault();
        window.history.back();
    });
    deleteTripBtn.addEventListener('click', deleteTrip);
    tripForm.addEventListener('submit', handleFormSubmit);

    // Initialize the page
    async function initializePage() {
        const urlParams = getUrlParams();
        pageId = urlParams.pageID;
        tripId = urlParams.tripID;

        // Determine if we're in create or edit mode
        isEditMode = !!(pageId && tripId);

        // Update UI based on mode
        updateUIMode();

        // Load user data silently (no alerts)
        await loadUserData();

        if (isEditMode) {
            console.log(`Loading trip: ${tripId} from page: ${pageId}`);
            await loadTripData();
        } else {
            console.log('Creating new trip mode');
        }
    }

    // Update UI based on create/edit mode
    function updateUIMode() {
        if (isEditMode) {
            pageTitle.textContent = 'Edit Trip';
            pageIcon.className = 'fas fa-edit';
            formTitle.textContent = 'Edit Trip Details';
            formIcon.className = 'fas fa-edit';
            submitText.textContent = 'Update Trip';
            submitIcon.className = 'fas fa-save';
            photoUploadLabel.textContent = 'Upload New Header Photo';
            photoUploadText.textContent = 'Click to upload a new header photo for your trip';
            deleteTripBtn.style.display = 'block';
            successTitle.textContent = 'Trip Updated Successfully!';
            successMessage.textContent = 'Your changes have been saved';
        } else {
            pageTitle.textContent = 'Create New Trip';
            pageIcon.className = 'fas fa-plus-circle';
            formTitle.textContent = 'Create New Trip';
            formIcon.className = 'fas fa-plus-circle';
            submitText.textContent = 'Create Trip';
            submitIcon.className = 'fas fa-plus-circle';
            photoUploadLabel.textContent = 'Upload Header Photo';
            photoUploadText.textContent = 'Click to upload a header photo for your trip';
            deleteTripBtn.style.display = 'none';
            successTitle.textContent = 'Trip Created Successfully!';
            successMessage.textContent = 'Your adventure is ready to begin';
        }
    }

    // Load user data from Firebase with photoURL support
    async function loadUserData() {
        try {
            // Get all users from the users node
            const usersRef = ref(database, 'users');
            const usersSnapshot = await get(usersRef);
            
            if (!usersSnapshot.exists()) {
                console.warn('No users found in database');
                showError('No users found in database. Please contact administrator.');
                return;
            }

            const users = usersSnapshot.val();
            let foundUser = null;
            let foundUserId = null;

            // If we're in edit mode, find user by pageID
            if (isEditMode && pageId) {
                for (const [userId, userData] of Object.entries(users)) {
                    if (userData.pageID === pageId) {
                        foundUser = userData;
                        foundUserId = userId;
                        break;
                    }
                }
            } else {
                // In create mode, use the first user
                const firstUserId = Object.keys(users)[0];
                if (firstUserId) {
                    foundUser = users[firstUserId];
                    foundUserId = firstUserId;
                    if (foundUser) {
                        pageId = foundUser.pageID; // Set pageId for create mode
                    }
                }
            }

            if (foundUser && foundUserId) {
                currentUser = foundUser;
                currentUserId = foundUserId; // Store the actual user ID
                
                // Update UI with user info
                userName.innerHTML = `${foundUser.firstName} ${foundUser.lastName}`;
                userEmail.innerHTML = foundUser.email;
                
                // Load and display user photo if available
                await loadUserPhoto(foundUser, foundUserId);
                
                console.log(`User loaded: ${foundUser.firstName} ${foundUser.lastName} (${foundUser.email}) with ID: ${foundUserId}`);
            } else {
                console.warn('User not found for this page');
                userName.innerHTML = 'User Not Found';
                userEmail.innerHTML = 'Please check user configuration';
                showError('User account not found. Please contact administrator.');
            }
            
        } catch (error) {
            console.error('Error loading user data:', error);
            userName.innerHTML = 'Error Loading User';
            userEmail.innerHTML = 'Please refresh the page';
            showError(`Failed to load user: ${getErrorMessage(error)}`);
        }
    }

    // Load user photo from various possible locations
    async function loadUserPhoto(userData, userId) {
        try {
            let userPhotoUrl = null;
            
            // Method 1: Check if photoURL is directly in user data
            if (userData.photoURL) {
                userPhotoUrl = userData.photoURL;
                console.log('Found user photoURL in user data:', userPhotoUrl);
            }
            
            // Method 2: Check user's photo library for profile photo
            if (!userPhotoUrl) {
                try {
                    const userPhotoLibraryRef = ref(database, `users/${userId}/photoLibrary`);
                    const photoLibrarySnapshot = await get(userPhotoLibraryRef);
                    
                    if (photoLibrarySnapshot.exists()) {
                        const photoLibrary = photoLibrarySnapshot.val();
                        
                        // Look for profile photos
                        for (const [fileName, photoInfo] of Object.entries(photoLibrary)) {
                            if (photoInfo.imageName && photoInfo.imageName.toLowerCase().includes('profile')) {
                                userPhotoUrl = photoInfo.imageUrl;
                                console.log('Found profile photo in user library:', userPhotoUrl);
                                break;
                            }
                        }
                        
                        // If no profile photo found, use the first available photo
                        if (!userPhotoUrl) {
                            const firstPhoto = Object.values(photoLibrary)[0];
                            if (firstPhoto && firstPhoto.imageUrl) {
                                userPhotoUrl = firstPhoto.imageUrl;
                                console.log('Using first available photo from user library:', userPhotoUrl);
                            }
                        }
                    }
                } catch (error) {
                    console.log('Error checking user photo library:', error);
                }
            }
            
            // Method 3: Check if there's a profile photo in storage with common naming pattern
            if (!userPhotoUrl) {
                const commonProfilePaths = [
                    `profile_photos/${userId}_profile.jpg`,
                    `profile_photos/${userId}.jpg`,
                    `users/${userId}/profile.jpg`,
                    `profile_pictures/${userId}.jpg`
                ];
                
                for (const path of commonProfilePaths) {
                    try {
                        const profileRef = storageRef(storage, path);
                        userPhotoUrl = await getDownloadURL(profileRef);
                        console.log('Found user photo in storage:', userPhotoUrl);
                        break;
                    } catch (error) {
                        // Continue to next path if this one fails
                        continue;
                    }
                }
            }
            
            // Update UI with user photo
            if (userPhotoUrl) {
                // Create or update user photo element in the DOM
                let userPhotoElement = document.getElementById('user-photo');
                if (!userPhotoElement) {
                    userPhotoElement = document.createElement('img');
                    userPhotoElement.id = 'user-photo';
                    userPhotoElement.className = 'user-photo';
                    userPhotoElement.alt = 'User Profile Photo';
                    
                    // Insert the photo before user details (replace the icon)
                    const userIcon = userInfo.querySelector('.fa-user-circle');
                    if (userIcon) {
                        userIcon.style.display = 'none'; // Hide the default icon
                    }
                    userInfo.insertBefore(userPhotoElement, userInfo.querySelector('.user-details'));
                }
                
                userPhotoElement.src = userPhotoUrl;
                userPhotoElement.style.display = 'block';
                
                console.log('User photo displayed successfully');
            } else {
                console.log('No user photo found');
                // Ensure default user icon is visible
                const userIcon = userInfo.querySelector('.fa-user-circle');
                if (userIcon) {
                    userIcon.style.display = 'block';
                }
            }
            
        } catch (error) {
            console.error('Error loading user photo:', error);
            // Don't show error for photo loading issues
        }
    }

    // Load trip data from Firebase (edit mode only)
    async function loadTripData() {
        try {
            // Load trip data from the exact structure: pages/{pageId}/trips/{tripId}
            const tripRef = ref(database, `pages/${pageId}/trips/${tripId}`);
            const tripSnapshot = await get(tripRef);
            
            if (!tripSnapshot.exists()) {
                showError('Trip not found');
                return;
            }

            currentTripData = tripSnapshot.val();
            console.log('Trip data loaded successfully:', currentTripData);

            // Populate form fields
            populateForm(currentTripData);

            // Load header photo info
            await loadHeaderPhotoInfo();
            
        } catch (error) {
            console.error('Error loading trip data:', error);
            showError(`Failed to load trip: ${getErrorMessage(error)}`);
        }
    }

    // Populate form with existing data
    function populateForm(tripData) {
        tripNameInput.value = tripData.title || '';
        tripDescriptionInput.value = tripData.subtitle || '';
        
        // Extract duration number from "X Days" format
        const durationMatch = (tripData.duration || '').match(/(\d+)/);
        tripDurationInput.value = durationMatch ? durationMatch[1] : '3';
        
        tripDifficultyInput.value = tripData.difficulty || 'Moderate';
        tripGroupSizeInput.value = tripData.groupSize || 'Up to 12 People';
        tripPriceInput.value = tripData.totalPrice || '450';
        
        // Populate locations
        if (tripData.locations && Array.isArray(tripData.locations)) {
            locationsContainer.innerHTML = '';
            tripData.locations.forEach((location, index) => {
                addLocationField();
                const inputs = locationsContainer.querySelectorAll('.location-input');
                if (inputs[index]) {
                    inputs[index].value = location;
                }
            });
        }
        
        // Populate tags
        tags = tripData.tags || [];
        renderTags();
    }

    // Load header photo information
    async function loadHeaderPhotoInfo() {
        try {
            console.log('Loading header photo info for trip:', tripId);
            
            let photoData = null;
            let photoUrl = null;

            // Method 1: Check if photos exist in the structure: pages/{pageId}/trips/{tripId}/photos/header
            try {
                const photoRef = ref(database, `pages/${pageId}/trips/${tripId}/photos/header`);
                const photoSnapshot = await get(photoRef);
                
                if (photoSnapshot.exists()) {
                    photoData = photoSnapshot.val();
                    console.log('Found photo in photos/header structure:', photoData);
                }
            } catch (error) {
                console.log('No photo found in photos/header structure');
            }

            // Method 2: Check if photo URL is directly in trip data
            if (!photoData && currentTripData && currentTripData.headerPhotoUrl) {
                photoUrl = currentTripData.headerPhotoUrl;
                console.log('Found photo URL directly in trip data:', photoUrl);
                
                // Create photo data object from trip data
                photoData = {
                    fileName: currentTripData.headerPhoto || 'header_photo',
                    imageUrl: photoUrl,
                    storagePath: `images/${currentTripData.headerPhoto}`,
                    imageName: "Trip Header Photo"
                };
            }

            // Method 3: Check user's photo library for this trip
            if (!photoData && currentUserId) {
                try {
                    const userPhotoLibraryRef = ref(database, `users/${currentUserId}/photoLibrary`);
                    const photoLibrarySnapshot = await get(userPhotoLibraryRef);
                    
                    if (photoLibrarySnapshot.exists()) {
                        const photoLibrary = photoLibrarySnapshot.val();
                        
                        // Look for photos used in this trip
                        for (const [fileName, photoInfo] of Object.entries(photoLibrary)) {
                            if (photoInfo.usedIn && Array.isArray(photoInfo.usedIn)) {
                                const usedInThisTrip = photoInfo.usedIn.some(usage => 
                                    usage.includes(tripId) && usage.includes('header')
                                );
                                
                                if (usedInThisTrip) {
                                    photoData = photoInfo;
                                    console.log('Found photo in user photo library:', photoData);
                                    break;
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.log('Error checking user photo library:', error);
                }
            }

            // If we found photo data, display it
            if (photoData) {
                currentHeaderPhoto = photoData;
                
                // Display current photo info
                currentPhotoInfo.style.display = 'block';
                currentPhotoName.textContent = photoData.fileName || 'Unknown';
                
                // Load and display the photo preview
                const displayUrl = photoData.imageUrl || photoUrl;
                if (displayUrl) {
                    photoPreview.src = displayUrl;
                    photoPreview.style.display = 'block';
                    photoUpload.style.display = 'none';
                    removePhotoBtn.style.display = 'flex';
                    console.log('Header photo displayed successfully');
                } else {
                    console.warn('No image URL found in photo data');
                }
                
            } else {
                currentPhotoInfo.style.display = 'none';
                console.log('No header photo found for this trip using any method');
            }
            
        } catch (error) {
            console.error('Error loading header photo:', error);
            // Don't show error to user for photo loading issues
        }
    }

    // Remove current photo (X button functionality)
    async function removeCurrentPhoto() {
        if (currentHeaderPhoto) {
            // If there's an existing photo in the database, ask for confirmation to delete it
            if (!confirm('Are you sure you want to delete this photo? This action cannot be undone.')) {
                return;
            }

            try {
                showOverlay('Deleting Photo', 'Removing photo from storage...');
                
                // Delete from storage
                if (currentHeaderPhoto.storagePath) {
                    const photoStorageRef = storageRef(storage, currentHeaderPhoto.storagePath);
                    await deleteObject(photoStorageRef);
                    console.log('Photo deleted from storage');
                }
                
                // Delete from database - remove the entire photos/header node
                const photoRef = ref(database, `pages/${pageId}/trips/${tripId}/photos/header`);
                await remove(photoRef);
                
                // Remove from user's photo library if it exists
                if (currentUserId && currentHeaderPhoto.fileName) {
                    const sanitizedFileName = sanitizePath(currentHeaderPhoto.fileName);
                    const userPhotoRef = ref(database, `users/${currentUserId}/photoLibrary/${sanitizedFileName}`);
                    await remove(userPhotoRef);
                }
                
                // Update trip data to remove photo references
                const tripRef = ref(database, `pages/${pageId}/trips/${tripId}`);
                await update(tripRef, {
                    headerPhoto: null,
                    headerPhotoUrl: null
                });
                
                // Clear local state
                currentHeaderPhoto = null;
                currentPhotoInfo.style.display = 'none';
                photoPreview.style.display = 'none';
                photoUpload.style.display = 'block';
                removePhotoBtn.style.display = 'none';
                
                console.log('Photo completely deleted');
                hideOverlay();
                showSuccess('Photo deleted successfully');
                
            } catch (error) {
                console.error('Error deleting photo:', error);
                showError(`Failed to delete photo: ${getErrorMessage(error)}`);
                hideOverlay();
            }
        } else if (headerPhotoFile) {
            // If it's just a newly uploaded file (not saved to database yet), just remove the preview
            removePhoto();
        }
    }

    // Remove newly uploaded photo (before saving)
    function removePhoto() {
        headerPhotoFile = null;
        photoPreview.style.display = 'none';
        photoUpload.style.display = 'block';
        removePhotoBtn.style.display = 'none';
        photoInput.value = '';
    }

    // Delete entire trip
    async function deleteTrip() {
        if (!confirm('Are you sure you want to delete this trip? This action cannot be undone.')) {
            return;
        }

        try {
            showOverlay('Deleting Trip', 'Removing trip and associated data...');
            
            // Delete header photo if exists
            if (currentHeaderPhoto && currentHeaderPhoto.storagePath) {
                try {
                    const photoStorageRef = storageRef(storage, currentHeaderPhoto.storagePath);
                    await deleteObject(photoStorageRef);
                    console.log('Trip photo deleted from storage');
                } catch (photoError) {
                    console.error('Error deleting trip photo:', photoError);
                    // Continue with trip deletion even if photo deletion fails
                }
            }
            
            // Delete entire trip from database - removes the whole trip node
            const tripRef = ref(database, `pages/${pageId}/trips/${tripId}`);
            await remove(tripRef);
            
            // Remove trip from user's trips list if user exists
            if (currentUserId) {
                const userTripsRef = ref(database, `users/${currentUserId}/userTrips`);
                const userTripsSnapshot = await get(userTripsRef);
                
                if (userTripsSnapshot.exists()) {
                    let userTrips = userTripsSnapshot.val();
                    userTrips = userTrips.filter(id => id !== tripId);
                    await set(userTripsRef, userTrips);
                }
            }
            
            console.log('Trip completely deleted');
            hideOverlay();
            
            // Redirect to dashboard
            alert('Trip deleted successfully! Redirecting to dashboard...');
            window.location.href = 'dashboard.html';
            
        } catch (error) {
            console.error('Error deleting trip:', error);
            showError(`Failed to delete trip: ${getErrorMessage(error)}`);
            hideOverlay();
        }
    }

    // Utility function to sanitize file names and paths
    function sanitizePath(path) {
        if (!path) return '';
        // Replace all invalid characters with underscores
        return path.replace(/[.#$[\]]/g, '_');
    }

    // Utility function to sanitize Firebase Database keys
    function sanitizeDatabaseKey(key) {
        if (!key) return '';
        // Replace all invalid characters for Firebase Database paths
        return key.replace(/[.#$[\]]/g, '_');
    }

    // Utility function to generate safe file names
    function generateSafeFileName(tripId, prefix = 'trip_header') {
        const timestamp = Date.now();
        const sanitizedTripId = sanitizePath(tripId);
        return `${prefix}_${sanitizedTripId}_${timestamp}.jpg`;
    }

    // Utility function to get proper error messages
    function getErrorMessage(error) {
        if (!error) return 'Unknown error occurred';
        
        console.log('Raw error object:', error);
        
        // Firebase Storage errors
        if (error.code) {
            switch (error.code) {
                case 'storage/unauthorized':
                    return 'Storage permission denied. Please check Firebase Storage rules.';
                case 'storage/canceled':
                    return 'Upload canceled';
                case 'storage/unknown':
                    return 'Unknown storage error occurred';
                case 'storage/invalid-argument':
                    return 'Invalid file path or argument';
                case 'storage/object-not-found':
                    return 'File not found in storage';
                case 'storage/quota-exceeded':
                    return 'Storage quota exceeded';
                case 'storage/unauthenticated':
                    return 'User not authenticated';
                default:
                    return `Storage error: ${error.code} - ${error.message || 'No additional details'}`;
            }
        }
        
        // Firebase Database errors
        if (error.message && error.message.includes('Permission denied')) {
            return 'Database permission denied. Please check Firebase Database rules.';
        }
        
        if (error.message && error.message.includes('set failed')) {
            return 'Failed to save data. Please check if all required fields are filled correctly.';
        }
        
        // Extract meaningful message
        if (error.message) {
            // Remove technical details for user-facing messages
            const message = error.message;
            if (message.includes('undefined')) {
                return 'Missing required data. Please refresh the page and try again.';
            }
            return message;
        }
        
        // Fallback for generic errors
        if (typeof error === 'string') {
            return error;
        }
        
        if (error.toString && error.toString() !== '[object Object]') {
            return error.toString();
        }
        
        return 'An unexpected error occurred. Please try again.';
    }

    // Overlay Functions
    function showOverlay(title, message) {
        overlayTitle.textContent = title;
        overlayMessage.textContent = message;
        overlay.style.display = 'flex';
        successContent.style.display = 'none';
        overlayProgressBar.style.width = '0%';
        overlayProgressText.textContent = '0%';
    }

    function hideOverlay() {
        overlay.style.display = 'none';
        hideUploadProgress();
    }

    function showSuccessOverlay() {
        overlayTitle.style.display = 'none';
        overlayMessage.style.display = 'none';
        overlayProgressBar.style.display = 'none';
        overlayProgressText.style.display = 'none';
        successContent.style.display = 'block';
    }

    function updateOverlayProgress(percentage, message = '') {
        overlayProgressBar.style.width = percentage + '%';
        overlayProgressText.textContent = Math.round(percentage) + '%';
        if (message) {
            overlayMessage.textContent = message;
        }
    }

    // Form Functions
    function addLocationField() {
        const locationItem = document.createElement('div');
        locationItem.className = 'location-edit-item';
        locationItem.innerHTML = `
            <input type="text" class="form-control location-input" placeholder="Enter a location">
            <button type="button" class="remove-btn" onclick="removeLocationField(this)">
                <i class="fas fa-times"></i>
            </button>
        `;
        locationsContainer.appendChild(locationItem);
        
        if (locationsContainer.children.length > 1) {
            locationsContainer.children[0].querySelector('.remove-btn').disabled = false;
        }
    }

    function removeLocationField(button) {
        if (locationsContainer.children.length > 1) {
            button.parentElement.remove();
            
            if (locationsContainer.children.length === 1) {
                locationsContainer.children[0].querySelector('.remove-btn').disabled = true;
            }
        }
    }

    function addTag() {
        const tagText = tagInput.value.trim();
        if (tagText && !tags.includes(tagText)) {
            tags.push(tagText);
            renderTags();
            tagInput.value = '';
        }
    }

    function removeTag(tagToRemove) {
        tags = tags.filter(tag => tag !== tagToRemove);
        renderTags();
    }

    function renderTags() {
        tagContainer.innerHTML = '';
        tags.forEach(tag => {
            const tagElement = document.createElement('div');
            tagElement.className = 'tag';
            tagElement.innerHTML = `
                ${tag}
                <i class="fas fa-times" onclick="removeTag('${tag}')"></i>
            `;
            tagContainer.appendChild(tagElement);
        });
    }

    function handlePhotoUpload(e) {
        const file = e.target.files[0];
        if (file) {
            if (file.type.startsWith('image/')) {
                if (file.size > 5 * 1024 * 1024) {
                    showError('Image size should be less than 5MB.');
                    return;
                }
                
                headerPhotoFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    photoPreview.src = e.target.result;
                    photoPreview.style.display = 'block';
                    photoUpload.style.display = 'none';
                    removePhotoBtn.style.display = 'flex';
                };
                reader.readAsDataURL(file);
            } else {
                showError('Please select a valid image file (JPEG, PNG, etc.).');
            }
        }
    }

    function resetForm() {
        if (isEditMode && currentTripData) {
            populateForm(currentTripData);
            // Reload photo info when resetting
            loadHeaderPhotoInfo();
        } else {
            tripForm.reset();
            locationsContainer.innerHTML = `
                <div class="location-edit-item">
                    <input type="text" class="form-control location-input" placeholder="Enter a location">
                    <button type="button" class="remove-btn" onclick="removeLocationField(this)" disabled>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            tags = [];
            renderTags();
        }
        removePhoto();
        hideAlerts();
        debugInfo.style.display = 'none';
        hideUploadProgress();
    }

    function showError(message) {
        hideOverlay();
        errorMessage.textContent = message;
        errorAlert.style.display = 'block';
        setTimeout(() => {
            errorAlert.style.display = 'none';
        }, 5000);
    }

    function showSuccess(message) {
        successAlertMessage.textContent = message || 'Operation completed successfully';
        successAlert.style.display = 'block';
        setTimeout(() => {
            successAlert.style.display = 'none';
        }, 5000);
    }

    function hideAlerts() {
        successAlert.style.display = 'none';
        errorAlert.style.display = 'none';
    }

    function showUploadProgress() {
        uploadProgress.style.display = 'block';
    }

    function hideUploadProgress() {
        uploadProgress.style.display = 'none';
        uploadProgressBar.style.width = '0%';
        uploadProgressText.textContent = '0%';
    }

    function updateUploadProgress(percentage) {
        uploadProgressBar.style.width = percentage + '%';
        uploadProgressText.textContent = Math.round(percentage) + '%';
    }

    function showDebugInfo(info) {
        debugInfo.innerHTML = `<strong>Debug Info:</strong><br>${info}`;
        debugInfo.style.display = 'block';
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        
        if (!tripNameInput.value.trim()) {
            showError('Please enter a trip name.');
            return;
        }

        if (!currentUser || !currentUserId) {
            showError('User not loaded. Please refresh the page.');
            return;
        }

        if (!pageId) {
            showError('Page ID not found. Please check user configuration.');
            return;
        }

        const action = isEditMode ? 'Updating' : 'Creating';
        showOverlay(`${action} Trip`, `${action.toLowerCase()} your trip...`);
        updateOverlayProgress(10, 'Preparing...');
        hideAlerts();
        debugInfo.style.display = 'none';
        hideUploadProgress();

        try {
            // Generate trip ID for new trips - SANITIZED
            if (!isEditMode) {
                tripId = "trip_" + Date.now();
                tripId = sanitizePath(tripId); // Sanitize the trip ID
            } else {
                // Sanitize existing trip ID
                tripId = sanitizePath(tripId);
            }
            
            // Get locations
            const locationInputs = document.querySelectorAll('.location-input');
            const locations = Array.from(locationInputs)
                .map(input => input.value.trim())
                .filter(location => location);

            // Create trip data following the exact structure
            const tripData = {
                title: tripNameInput.value.trim(),
                subtitle: tripDescriptionInput.value.trim(),
                duration: `${tripDurationInput.value} Days`,
                difficulty: tripDifficultyInput.value,
                groupSize: tripGroupSizeInput.value,
                totalPrice: parseFloat(tripPriceInput.value) || 0,
                tags: tags || [],
                locations: locations || [],
                createdBy: currentUserId,
                updatedAt: new Date().toISOString(),
                status: "active"
            };

            // Add createdAt for new trips
            if (!isEditMode) {
                tripData.createdAt = new Date().toISOString();
            }

            console.log('Saving trip data:', { 
                pageId, 
                tripId, 
                userId: currentUserId,
                tripData: JSON.stringify(tripData, null, 2)
            });

            // Upload new header photo if selected
            if (headerPhotoFile) {
                updateOverlayProgress(30, 'Uploading photo...');
                
                // Delete old photo if exists (in edit mode)
                if (isEditMode && currentHeaderPhoto && currentHeaderPhoto.storagePath) {
                    try {
                        const oldPhotoRef = storageRef(storage, currentHeaderPhoto.storagePath);
                        await deleteObject(oldPhotoRef);
                        console.log('Old photo deleted from storage');
                    } catch (deleteError) {
                        console.error('Error deleting old photo:', getErrorMessage(deleteError));
                        // Continue with upload even if deletion fails
                    }
                }

                // Upload new photo with SAFE file naming
                const timestamp = Date.now();
                const headerPhotoFileName = generateSafeFileName(tripId, 'trip_header');
                const photoStoragePath = `images/${headerPhotoFileName}`;
                const photoStorageRef = storageRef(storage, photoStoragePath);
                
                showUploadProgress();
                
                const uploadTask = uploadBytesResumable(photoStorageRef, headerPhotoFile);
                
                await new Promise((resolve, reject) => {
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            const overallProgress = 30 + (progress * 0.3);
                            updateUploadProgress(progress);
                            updateOverlayProgress(overallProgress, `Uploading photo: ${Math.round(progress)}%`);
                        },
                        (error) => {
                            console.error('Photo upload error details:', {
                                code: error.code,
                                message: error.message,
                                name: error.name,
                                stack: error.stack
                            });
                            reject(new Error(`Photo upload failed: ${getErrorMessage(error)}`));
                        },
                        async () => {
                            try {
                                const headerPhotoUrl = await getDownloadURL(uploadTask.snapshot.ref);
                                console.log('Photo uploaded successfully, URL:', headerPhotoUrl);
                                
                                // Create photos structure exactly as specified
                                const tripPhotosRef = ref(database, `pages/${pageId}/trips/${tripId}/photos/header`);
                                const photoData = {
                                    fileName: headerPhotoFileName,
                                    imageName: "Trip Header Photo",
                                    uploadedBy: currentUserId,
                                    uploadedAt: new Date().toISOString(),
                                    imageUrl: headerPhotoUrl,
                                    storagePath: photoStoragePath
                                };
                                
                                console.log('Saving photo data to database:', JSON.stringify(photoData, null, 2));
                                await set(tripPhotosRef, photoData);
                                
                                // Update user's photo library with SANITIZED path
                                const sanitizedFileName = sanitizeDatabaseKey(headerPhotoFileName);
                                const userPhotoRef = ref(database, `users/${currentUserId}/photoLibrary/${sanitizedFileName}`);
                                await set(userPhotoRef, {
                                    fileName: headerPhotoFileName,
                                    imageName: "Trip Header Photo",
                                    uploadedAt: new Date().toISOString(),
                                    usedIn: [`${tripId}/header`],
                                    imageUrl: headerPhotoUrl,
                                    storagePath: photoStoragePath
                                });
                                
                                // Add to trip data
                                tripData.headerPhoto = headerPhotoFileName;
                                tripData.headerPhotoUrl = headerPhotoUrl;
                                
                                hideUploadProgress();
                                resolve();
                            } catch (error) {
                                console.error('Error saving photo data details:', {
                                    message: error.message,
                                    code: error.code,
                                    name: error.name,
                                    stack: error.stack
                                });
                                reject(new Error(`Failed to save photo data: ${getErrorMessage(error)}`));
                            }
                        }
                    );
                });
            }

            updateOverlayProgress(70, 'Saving trip details...');
            
            // Save/Update trip data in the exact structure: pages/{pageId}/trips/{tripId}
            const tripRef = ref(database, `pages/${pageId}/trips/${tripId}`);
            console.log('Saving to database path:', `pages/${pageId}/trips/${tripId}`);
            
            if (isEditMode) {
                await update(tripRef, tripData);
            } else {
                await set(tripRef, tripData);
                
                // Add to user's trips list for new trips
                const userTripsRef = ref(database, `users/${currentUserId}/userTrips`);
                const userTripsSnapshot = await get(userTripsRef);
                
                let userTrips = [];
                if (userTripsSnapshot.exists()) {
                    userTrips = userTripsSnapshot.val();
                    // Ensure userTrips is an array
                    if (!Array.isArray(userTrips)) {
                        userTrips = [];
                    }
                }
                
                userTrips.push(tripId);
                await set(userTripsRef, userTrips);
            }
            
            updateOverlayProgress(100, 'Finalizing...');
            
            // Show success
            setTimeout(() => {
                showSuccessOverlay();
                
                // Show appropriate success message based on mode
                if (isEditMode) {
                    showSuccess('Trip updated successfully!');
                } else {
                    showSuccess('Trip created successfully!');
                }
                
                // If creating new trip, switch to edit mode
                if (!isEditMode) {
                    isEditMode = true;
                    updateUIMode();
                    // Update URL without reloading
                    const newUrl = `${window.location.pathname}?pageID=${pageId}&tripID=${tripId}`;
                    window.history.pushState({}, '', newUrl);
                }
                
                // Reload photo info after save
                loadHeaderPhotoInfo();
            }, 1000);
            
        } catch (error) {
            console.error('Full error object:', error);
            console.error('Error saving trip details:', {
                name: error.name,
                message: error.message,
                code: error.code,
                stack: error.stack
            });
            hideUploadProgress();
            showError(`Failed to ${isEditMode ? 'update' : 'create'} trip: ${getErrorMessage(error)}`);
        }
    }

    // Make functions available globally
    window.removeLocationField = removeLocationField;
    window.removeTag = removeTag;
    window.hideOverlay = hideOverlay;

    // Initialize page when loaded
    document.addEventListener('DOMContentLoaded', initializePage);
</script>

</body>
</html>
    
  </body>
  
</html>
